<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Sports Event Management</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../css/styles.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">SportEvents</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="customize.html">Customize Event</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="packages.html">Packages</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="services.html">Services</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html#about">About Us</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Checkout Section -->
    <section class="py-5">
        <div class="container">
            <h1 class="text-center mb-5">Checkout</h1>

            <div class="row">
                <!-- Order Summary -->
                <div class="col-md-8">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h3 class="card-title">Order Summary</h3>
                            <div id="orderItems">
                                <!-- Order items will be populated here -->
                            </div>

                            <hr>

                            <div class="d-flex justify-content-between">
                                <span>Subtotal:</span>
                                <span id="subtotal">$0.00</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Management Fee (10%):</span>
                                <span id="managementFee">$0.00</span>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <strong>Total:</strong>
                                <strong id="total">$0.00</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Form -->
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-title mb-4">Payment Details</h3>
                            <form id="paymentForm" class="needs-validation" novalidate>
                                <div class="mb-3">
                                    <label for="cardName" class="form-label">Name on Card</label>
                                    <input type="text" class="form-control" id="cardName" required>
                                    <div class="invalid-feedback">
                                        Please enter the name on your card.
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="cardNumber" class="form-label">Card Number</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="cardNumber"
                                               pattern="[0-9]{16}" required>
                                        <span class="input-group-text">
                                            <i class="fab fa-cc-visa me-1"></i>
                                            <i class="fab fa-cc-mastercard"></i>
                                        </span>
                                    </div>
                                    <div class="invalid-feedback">
                                        Please enter a valid 16-digit card number.
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="expiry" class="form-label">Expiry Date</label>
                                        <input type="text" class="form-control" id="expiry"
                                               placeholder="MM/YY" pattern="(0[1-9]|1[0-2])\/([0-9]{2})" required>
                                        <div class="invalid-feedback">
                                            Please enter a valid expiry date (MM/YY).
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="cvv" class="form-label">CVV</label>
                                        <input type="text" class="form-control" id="cvv"
                                               pattern="[0-9]{3,4}" required>
                                        <div class="invalid-feedback">
                                            Please enter a valid CVV.
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="email" class="form-label">Email for Receipt</label>
                                    <input type="email" class="form-control" id="email" required>
                                    <div class="invalid-feedback">
                                        Please enter a valid email address.
                                    </div>
                                </div>

                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        Pay Now
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Order Details Sidebar -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-title">Order Details</h3>
                            <div id="orderDetails">
                                <!-- Order details will be populated here -->
                            </div>

                            <hr>

                            <div class="alert alert-info" role="alert">
                                <i class="fas fa-info-circle me-2"></i>
                                Management fee applies to all bookings
                            </div>

                            <div class="mt-3">
                                <h4>Need Help?</h4>
                                <a href="https://wa.me/1234567890" class="btn btn-success w-100 mb-2">
                                    <i class="fab fa-whatsapp me-2"></i>WhatsApp Support
                                </a>
                                <a href="tel:+1234567890" class="btn btn-outline-primary w-100">
                                    <i class="fas fa-phone me-2"></i>Call Us
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="py-4 bg-dark">
        <div class="container">
            <div class="row">
                <div class="col-md-6 text-center text-md-start">
                    <p>&copy; 2024 SportEvents. All rights reserved.</p>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <a href="#" class="text-white me-3"><i class="fab fa-facebook"></i></a>
                    <a href="#" class="text-white me-3"><i class="fab fa-twitter"></i></a>
                    <a href="#" class="text-white me-3"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
    </footer>

    <style>
        @media print {
            body * {
                visibility: hidden;
            }
            #paymentReceipt, #paymentReceipt * {
                visibility: visible;
            }
            #paymentReceipt {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 15px;
            }
            #paymentReceipt button {
                display: none;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/main.js"></script>
    <script>
        function printOnlyReceipt() {
            window.print();
        }
        
        // Get order details from URL parameters and localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const orderType = urlParams.get('type');
        let subtotal = 0;

        // Initialize page
        function initializePage() {
            const orderItemsContainer = document.getElementById('orderItems');
            const orderDetailsContainer = document.getElementById('orderDetails');

            if (orderType === 'event') {
                // Handle custom event data
                const eventData = JSON.parse(localStorage.getItem('customEvent'));
                console.log('Event data:', eventData); // Debug log

                if (eventData) {
                    const basePrice = 1000; // Base price for custom events
                    const participantFee = Math.floor(eventData.participants / 50) * 200; // Additional fee per 50 participants
                    subtotal = basePrice + participantFee;

                    orderItemsContainer.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-3 animate__animated animate__fadeIn">
                            <div>
                                <h5>Custom Event Package</h5>
                                <small class="text-muted">Base Price</small>
                            </div>
                            <span>$${basePrice.toFixed(2)}</span>
                        </div>
                        ${participantFee > 0 ? `
                        <div class="d-flex justify-content-between align-items-center mb-3 animate__animated animate__fadeIn">
                            <div>
                                <h5>Participant Fee</h5>
                                <small class="text-muted">Additional charge for ${eventData.participants} participants</small>
                            </div>
                            <span>$${participantFee.toFixed(2)}</span>
                        </div>
                        ` : ''}
                    `;

                    orderDetailsContainer.innerHTML = `
                        <div class="animate__animated animate__fadeIn">
                            <p><strong>Event Type:</strong> Custom</p>
                            <p><strong>Sports:</strong> ${eventData.sports.join(', ')}</p>
                            <p><strong>Location:</strong> ${eventData.location}</p>
                            <p><strong>Date:</strong> ${new Date(eventData.eventDate).toLocaleDateString()}</p>
                            <p><strong>Participants:</strong> ${eventData.participants}</p>
                            ${eventData.requirements ? `<p><strong>Requirements:</strong> ${eventData.requirements}</p>` : ''}
                        </div>
                    `;
                } else {
                    showEmptyCartMessage(orderItemsContainer);
                }
            } else if (orderType === 'package') {
                // Handle package data
                const package = urlParams.get('package');
                if (package) {
                    const packageName = package.charAt(0).toUpperCase() + package.slice(1);
                    const packagePrice = package === 'platinum' ? 5000 : 3000;
                    subtotal = packagePrice;

                    orderItemsContainer.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-3 animate__animated animate__fadeIn">
                            <div>
                                <h5>${packageName} Package</h5>
                                <small class="text-muted">Complete event management solution</small>
                            </div>
                            <span>$${packagePrice.toFixed(2)}</span>
                        </div>
                    `;

                    orderDetailsContainer.innerHTML = `
                        <div class="animate__animated animate__fadeIn">
                            <p><strong>Package Type:</strong> ${packageName}</p>
                            <p><strong>Duration:</strong> Full Event</p>
                            <p><strong>Services Included:</strong> All Core Services</p>
                        </div>
                    `;
                } else {
                    showEmptyCartMessage(orderItemsContainer);
                }
            } else if (orderType === 'service') {
                // Handle selected services data
                const servicesData = JSON.parse(localStorage.getItem('selectedServices'));
                console.log('Services data:', servicesData); // Debug log

                if (servicesData && servicesData.length > 0) {
                    let servicesHtml = '';
                    let servicesTotal = 0;

                    servicesData.forEach(service => {
                        servicesHtml += `
                            <div class="d-flex justify-content-between align-items-center mb-3 animate__animated animate__fadeIn">
                                <div>
                                    <h5>${service.name}</h5>
                                    <small class="text-muted">Individual service</small>
                                </div>
                                <span>$${service.price.toFixed(2)}</span>
                            </div>
                        `;
                        servicesTotal += service.price;
                    });

                    orderItemsContainer.innerHTML = servicesHtml;
                    subtotal = servicesTotal;

                    // Create a list of service names for the details section
                    const serviceNames = servicesData.map(service => service.name).join(', ');

                    orderDetailsContainer.innerHTML = `
                        <div class="animate__animated animate__fadeIn">
                            <p><strong>Order Type:</strong> À la carte Services</p>
                            <p><strong>Services Selected:</strong> ${serviceNames}</p>
                            <p><strong>Number of Services:</strong> ${servicesData.length}</p>
                        </div>
                    `;
                } else {
                    showEmptyCartMessage(orderItemsContainer);
                }
            } else {
                showEmptyCartMessage(orderItemsContainer);
            }

            calculateTotals(subtotal);
        }

        function showEmptyCartMessage(container) {
            container.innerHTML = `
                <div class="alert alert-info animate__animated animate__fadeIn">
                    <i class="fas fa-info-circle me-2"></i>
                    No items in cart. Please select a package or customize an event first.
                </div>
            `;
        }

        function calculateTotals(subtotalAmount) {
            const managementFeeRate = 0.10; // 10%
            const managementFeeAmount = subtotalAmount * managementFeeRate;
            const totalAmount = subtotalAmount + managementFeeAmount;

            document.getElementById('subtotal').textContent = `$${subtotalAmount.toFixed(2)}`;
            document.getElementById('managementFee').textContent = `$${managementFeeAmount.toFixed(2)}`;
            document.getElementById('total').textContent = `$${totalAmount.toFixed(2)}`;
        }

        // Form validation and submission
        const paymentForm = document.getElementById('paymentForm');
        const totalAmount = document.getElementById('total').textContent;

        paymentForm.addEventListener('submit', function(event) {
            event.preventDefault();

            if (!paymentForm.checkValidity()) {
                event.stopPropagation();
            } else {
                // Show processing state
                const submitButton = paymentForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerHTML = `
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    Processing...
                `;
                
                // Get the actual payment amount (without the dollar sign)
                const totalAmount = parseFloat(document.getElementById('total').textContent.replace('$', ''));
                
                // Prepare payment data
                const paymentData = {
                    amount: totalAmount,
                    payment_method: 'credit_card',
                    status: 'completed',
                    user_info: {
                        name: document.getElementById('cardName').value,
                        email: document.getElementById('email').value,
                        card_last4: document.getElementById('cardNumber').value.slice(-4)
                    }
                };
                
                // Add the appropriate ID based on the order type
                if (orderType === 'event') {
                    const eventData = JSON.parse(localStorage.getItem('customEvent'));
                    if (eventData && eventData.id) {
                        paymentData.event_id = eventData.id;
                    }
                } else if (orderType === 'service') {
                    const servicesData = JSON.parse(localStorage.getItem('selectedServices'));
                    if (servicesData && servicesData.length > 0) {
                        paymentData.service_ids = servicesData.map(service => service.id);
                    }
                } else if (orderType === 'package') {
                    const package = urlParams.get('package');
                    if (package) {
                        // We'll need the actual package ID here, but for now we'll use a placeholder
                        paymentData.package_id = package;
                    }
                }
                
                // Submit payment data to the server
                fetch('/api/payments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Payment saved:', data);
                })
                .catch(error => {
                    console.error('Error saving payment:', error);
                });

                // Create a payment progress container
                const paymentProgressContainer = document.createElement('div');
                paymentProgressContainer.className = 'mt-4';
                paymentProgressContainer.innerHTML = `
                    <h5>Test Payment Process</h5>
                    <div class="alert alert-info">
                        <p><strong>Amount:</strong> ${totalAmount}</p>
                        <p><strong>Card:</strong> **** **** **** ${document.getElementById('cardNumber').value.slice(-4)}</p>
                        <p><strong>Status:</strong> <span id="paymentStatus">Verifying card details...</span></p>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                `;
                paymentForm.parentNode.insertBefore(paymentProgressContainer, paymentForm.nextSibling);
                
                const paymentStatus = document.getElementById('paymentStatus');
                const progressBar = paymentProgressContainer.querySelector('.progress-bar');

                // Step 1: Verify card details
                setTimeout(() => {
                    paymentStatus.textContent = 'Processing payment...';
                    progressBar.style.width = '50%';
                    progressBar.setAttribute('aria-valuenow', 50);
                    
                    // Step 2: Process payment
                    setTimeout(() => {
                        paymentStatus.textContent = 'Completing transaction...';
                        progressBar.style.width = '75%';
                        progressBar.setAttribute('aria-valuenow', 75);
                        
                        // Step 3: Finalize transaction
                        setTimeout(() => {
                            progressBar.style.width = '100%';
                            progressBar.setAttribute('aria-valuenow', 100);
                            progressBar.classList.remove('progress-bar-animated');
                            
                            // Show success message
                            const successAlert = document.createElement('div');
                            successAlert.className = 'alert alert-success mt-3';
                            successAlert.innerHTML = `
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>Payment Successful!</strong>
                                <p class="mb-0">Transaction ID: TEST-${Math.floor(Math.random() * 1000000)}</p>
                                <p class="mb-0">A confirmation email has been sent to ${document.getElementById('email').value}</p>
                            `;
                            paymentProgressContainer.parentNode.insertBefore(successAlert, paymentProgressContainer.nextSibling);
                            
                            // Update payment status
                            paymentStatus.textContent = 'Payment completed successfully';
                            paymentStatus.className = 'text-success fw-bold';
                            
                            // Add payment receipt
                            const receiptContainer = document.createElement('div');
                            receiptContainer.className = 'card mt-3 mb-3';
                            receiptContainer.id = 'paymentReceipt';
                            // Get the actual total amount from the page
                            const actualTotalAmount = document.getElementById('total').textContent;
                            receiptContainer.innerHTML = `
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">Test Payment Receipt</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Date:</strong> ${new Date().toLocaleString()}</p>
                                    <p><strong>Amount:</strong> ${actualTotalAmount}</p>
                                    <p><strong>Payment Method:</strong> Credit Card (**** ${document.getElementById('cardNumber').value.slice(-4)})</p>
                                    <p><strong>Email:</strong> ${document.getElementById('email').value}</p>
                                    <p><strong>Status:</strong> <span class="badge bg-success">PAID</span></p>
                                    <div class="d-grid">
                                        <button class="btn btn-outline-secondary btn-sm mt-2" onclick="printOnlyReceipt()">
                                            <i class="fas fa-print me-2"></i>Print Receipt
                                        </button>
                                    </div>
                                </div>
                            `;
                            paymentProgressContainer.parentNode.insertBefore(receiptContainer, successAlert.nextSibling);

                            // Reset form and storage
                            paymentForm.reset();
                            submitButton.disabled = false;
                            submitButton.innerHTML = 'Pay Now';
                            localStorage.removeItem('customEvent');
                            localStorage.removeItem('selectedServices');

                            // Add return to home button
                            const returnButton = document.createElement('div');
                            returnButton.className = 'd-grid mt-3';
                            returnButton.innerHTML = `
                                <button class="btn btn-primary" onclick="window.location.href='../index.html'">
                                    <i class="fas fa-home me-2"></i>Return to Home
                                </button>
                            `;
                            receiptContainer.parentNode.insertBefore(returnButton, receiptContainer.nextSibling);
                        }, 1000);
                    }, 1500);
                }, 1000);
            }

            paymentForm.classList.add('was-validated');
        });

        // Format card number input
        const cardNumberInput = document.getElementById('cardNumber');
        cardNumberInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 16) value = value.slice(0, 16);
            e.target.value = value;
        });

        // Format expiry date input
        const expiryInput = document.getElementById('expiry');
        expiryInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 2) {
                value = value.slice(0, 2) + '/' + value.slice(2, 4);
            }
            e.target.value = value;
        });

        // Initialize page on load
        initializePage();
    </script>
</body>
</html>